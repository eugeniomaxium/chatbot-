<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Petroleum Academy ChatBot</title>
  <style>
    body { font-family: Arial; background: #f5f5f5; margin: 0; padding: 0; }
    #chat-toggle {
      position: fixed; bottom: 20px; right: 20px;
      width: 60px; height: 60px;
      background-color: #007bff; border: none; border-radius: 50%;
      color: white; font-size: 28px; cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2); z-index: 1000;
    }
    #chat-container {
      position: fixed; bottom: 90px; right: 20px;
      width: 400px; max-width:90vw;
      border: 1px solid #ccc; border-radius: 10px;
      background: #fff; padding: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.1);
      display: none; z-index: 999;
    }
    #chat-close {
      position: absolute; top: 10px; right: 10px;
      background: none; border: none; font-size: 18px;
      cursor: pointer; color: #888;
    }
    #chatbox {
      height: 300px; overflow-y: auto; border:1px solid #ddd;
      padding:10px; margin-bottom:10px; background:#fafafa;
    }
    .message { margin-bottom: 8px; }
    .user { color: blue; font-weight: bold; }
    .bot { color: green; font-style: italic; }
    #input-area { display:flex; gap:6px; align-items: center; }
    #input { flex-grow:1; padding:8px; font-size:14px; }
    #send, #mic { padding:8px 12px; font-size: 14px; cursor: pointer; }
  </style>
</head>
<body>
  <button id="chat-toggle">💬</button>

  <div id="chat-container">
    <button id="chat-close">✖</button>
    <div id="chatbox"></div>
    <div id="input-area">
      <input type="text" id="input" placeholder="Ask something..." />
      <button id="send">Send</button>
      <button id="mic">🎤</button>
    </div>
  </div>

  <script>
    const chatToggle = document.getElementById('chat-toggle');
    const chatContainer = document.getElementById('chat-container');
    const chatClose = document.getElementById('chat-close');
    const chatbox = document.getElementById('chatbox');
    const input = document.getElementById('input');
    const send = document.getElementById('send');
    const mic = document.getElementById('mic');

    let recognition;
    let recognizing = false;
    let voiceModeActive = false; // Track if mic was on before speaking

    function addMessage(cls, text) {
      const d = document.createElement('div');
      d.className = 'message ' + cls;
      d.textContent = (cls === 'user' ? 'You: ' : '') + text;
      chatbox.appendChild(d);
      chatbox.scrollTop = chatbox.scrollHeight;
    }

    function speak(text) {
      // Stop mic while speaking
      if (recognition && recognizing) {
        recognition.stop();
        recognizing = false;
        mic.textContent = '🎤';
      }

      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'en-US';

      utterance.onend = () => {
        // Only restart mic if voice mode was active before speaking
        if (voiceModeActive) {
          setTimeout(() => {
            if (recognition && !recognizing) {
              recognition.start();
              recognizing = true;
              mic.textContent = '🎙️';
            }
          }, 2000); // delay in ms
        }
      };

      speechSynthesis.speak(utterance);
    }

    function getBotReply(msg) {
      const m = msg.toLowerCase();
      if (m.includes('mission')) {
        return 'Our mission is empowering students with expert-guided education and practical training.';
      }
      if (m.includes('why choose') || m.includes('why should i choose')) {
        return 'Choose Petroleum Academy for world-class instructors, engaging content, and a supportive community to help you reach your goals faster.';
      }
      if (m.includes('contact')) {
        return 'Fill out the contact form on their website with your name, email, and message, then click "Enviar Mensaje".';
      }
      if (m.includes('social media') || m.includes('follow')) {
        return 'You can follow them via the Facebook page mentioned in the footer of their website.';
      }
      if (m.includes('courses') || m.includes('popular courses')) {
        return 'They offer Universidad de la Marina Mercante program, Curso de Inglés Técnico, and Ciberseguridad Industrial.';
      }
      if (m.includes('inglés técnico') || m.includes('english course')) {
        return 'The Technical English course teaches English from basic to advanced across six certificate-levels.';
      }
      if (m.includes('ciberseguridad') || m.includes('industrial cybersecurity')) {
        return 'The Industrial Cybersecurity course focuses on protecting Industrial Control Systems and OT environments.';
      }
      if (m.includes('testimonials') || m.includes('student')) {
        return 'Here’s a testimonial: "Petroleum Academy cambió mi vida! Los instructores son muy útiles y los cursos son de primera calidad." — Noreen B.';
      }
      if (m.includes('start') || m.includes('comienza ahora')) {
        return 'To start, click "Comienza Ahora" (Start Now) on their website.';
      }
      if (m.includes('certificate')) {
        return 'Yes, each level of the Technical English course provides a certificate from Universidad de la Marina Mercante.';
      }
      return 'Sorry, I don’t have an answer for that. Try asking about mission, courses, contact or testimonials.';
    }

    function sendMessage(){
      const msg = input.value.trim();
      if (!msg) return;
      addMessage('user', msg);
      input.value = '';
      setTimeout(() => {
        const reply = getBotReply(msg);
        addMessage('bot', reply);
        speak(reply);
      }, 400);
    }

    chatToggle.onclick = () => {
      chatContainer.style.display = 'block';
      addMessage('bot', 'Hello, how can I help you today?');
      speak('Hello, how can I help you today?');
    };
    chatClose.onclick = () => chatContainer.style.display = 'none';

    send.onclick = sendMessage;
    input.addEventListener('keydown', e => { if(e.key==='Enter') sendMessage(); });

    function startVoiceRecognition() {
      if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
        alert('Speech recognition not supported in this browser.');
        return;
      }

      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.lang = 'en-US';
      recognition.interimResults = false;
      recognition.continuous = false; // only listen once

      recognition.onstart = () => {
        recognizing = true;
        mic.textContent = '🎙️';
      };

      recognition.onend = () => {
        recognizing = false;
        mic.textContent = '🎤';
        // No auto-restart here; speak() handles it if needed
      };

      recognition.onresult = function(event) {
        const transcript = event.results[event.results.length - 1][0].transcript;
        input.value = transcript;
        sendMessage();
      };

      recognition.onerror = function(event) {
        console.error('Speech recognition error:', event.error);
      };

      recognition.start();
    }

    mic.onclick = () => {
      if (!recognizing) {
        voiceModeActive = true; // mic activated by user
        startVoiceRecognition();
      } else {
        recognition.stop();
        recognizing = false;
        voiceModeActive = false; // mic turned off manually
        mic.textContent = '🎤';
      }
    };
  </script>
</body>
</html>

